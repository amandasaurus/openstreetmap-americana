<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Display a map</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://unpkg.com/maplibre-gl@1.14.0/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@1.14.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>

    <!-- This file needs to be modified with your MapTiler Cloud key -->
    <script type="text/javascript" src="key.js"></script>

    <script type="text/javascript" src="constants/color.js"></script>
    <script type="text/javascript" src="constants/line.js"></script>

    <script type="text/javascript" src="layer/background.js"></script>
    <script type="text/javascript" src="layer/water.js"></script>
    <script type="text/javascript" src="layer/road_casing.js"></script>
    <script type="text/javascript" src="layer/road.js"></script>
    <script type="text/javascript" src="layer/bridge.js"></script>
    <script type="text/javascript" src="layer/tunnel.js"></script>
    <script type="text/javascript" src="layer/highway_shield.js"></script>
    <script type="text/javascript" src="layer/highway_exit.js"></script>
    <script type="text/javascript" src="layer/oneway.js"></script>

    <script type="text/javascript" src="layers.js"></script>
  </head>

  <body>
    <div id="map"></div>
    <script>
      var style = {
        id: "streets",
        name: "Americana",
        zoom: 1,
        pitch: 0,
        center: [0, 0],
        glyphs: "http://fonts.openmaptiles.org/{fontstack}/{range}.pbf",
        layers: americanaLayers,
        sprite: new URL("/sprites/sprite", window.location.origin).href,
        bearing: 0,
        sources: {
          openmaptiles: {
            url: "http://localhost:8080/data/v3.json", // "https://api.maptiler.com/tiles/v3/tiles.json?key=" + mapTilerKey,
            type: "vector",
          },
          openmaptiles_test: {
            url: "http://localhost:8080/data/v3.json",
            type: "vector",
          },
          maptiler_attribution: {
            type: "vector",
            attribution:
              '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
          },
        },
        version: 8,
        metadata: {
          "mapbox:type": "template",
          "maptiler:copyright":
            "This style was generated on MapTiler Cloud. Usage outside of MapTiler Cloud requires valid OpenMapTiles Production Package: https://openmaptiles.com/production-package/ -- please contact us.",
          "openmaptiles:version": "3.x",
        },
      };

      var map = new maplibregl.Map({
        container: "map", // container id
        hash: true,
        antialias: true,
        style: style,
        center: [-74.5, 40], // starting position [lng, lat]
        zoom: 8, // starting zoom
      });

      function loadShield(ctx, shield) {
        var imgData = ctx.createImageData(
          shield.data.width,
          shield.data.height
        );
        for (i = 0; i < shield.data.data.length; i++) {
          imgData.data[i] = shield.data.data[i];
        }
        ctx.putImageData(imgData, 0, 0);
      }

      map.on("styleimagemissing", function (e) {
        var id = e.id;

        if (id == "shield_") {
          return;
        }

        var network_ref = id.split("_")[1];
        var network_ref_parts = network_ref.split("=");
        var network = network_ref_parts[0];
        var ref = network_ref_parts[1];

        var width = 20;
        var height = 20;
        var scaleH = 1;
        var scaleW = 1;

        var c = document.createElement("canvas");
        var ctx = c.getContext("2d");
        ctx.imageSmoothingQuality = "high";
        ctx.mozImageSmoothingEnabled = true;
        ctx.webkitImageSmoothingEnabled = true;
        ctx.msImageSmoothingEnabled = true;
        ctx.imageSmoothingEnabled = true;

        var shieldImages = map.style.imageManager.images;
        switch (network) {
          case "US:I":
            {
              var shield = shieldImages.shield40_us_interstate;
              scaleH = shield.data.height / height;
              scaleW = shield.data.width / width;
              loadShield(ctx, shield);

              ctx.fillStyle = "white";
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              if (ref.length <= 2) {
                ctx.font = "bold 44pt Arial";
              } else {
                ctx.font = "bold 30pt Arial";
              }
              ctx.fillText(
                ref,
                height * scaleH * 0.5,
                width * scaleW * 0.56,
                width * scaleW
              );
            }
            break;
          case "US:US":
            {
              var shield = shieldImages.shield40_us_us;
              scaleW = shield.data.width / width;
              scaleH = shield.data.height / height;

              loadShield(ctx, shield);

              ctx.fillStyle = "black";
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              if (ref.length <= 2) {
                ctx.font = "bold 42pt Arial";
              } else {
                ctx.font = "bold 28pt Arial";
              }
              ctx.fillText(
                ref,
                width * scaleW * 0.5,
                height * scaleH * 0.56,
                width * scaleW
              );
            }
            break;

          default: {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, 20, 20);
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, 20, 20);

            ctx.fillStyle = "black";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            if (ref.length <= 2) {
              ctx.font = "bold 11pt Arial";
            } else {
              ctx.font = "bold 7pt Arial";
            }
            ctx.fillText(ref, width * 0.5, height * 0.58, width);
          }
        }

        var scaleCanvas = document.createElement("canvas");
        var scaleCtx = scaleCanvas.getContext("2d");
        scaleCtx.scale(1 / scaleW, 1 / scaleH);
        scaleCtx.drawImage(c, 0, 0);

        var imgData = scaleCtx.getImageData(0, 0, height, width);

        map.addImage(id, {
          width: width,
          height: width,
          data: imgData.data,
        });

        console.log(id);
      });
    </script>
  </body>
</html>
